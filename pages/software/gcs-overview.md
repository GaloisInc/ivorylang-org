# Ground Control Station (GCS)

This page describes interacting with SMACCMPilot from a ground control station
(GCS).  The GCS has only been tested on Linux distributions and particularly
Fedora.

## GCS Setup and Operation

Communication is with the GCS currently uses the [MAVLink][] message protocol.
In addition, SMACCMPilot uses an encryption and authentication protocol, based
on [AES in Galois/Counter mode.][aesgcm-wiki] specialized for low bandwidth
radios.  Thus, the user is responsible for setting private keys and encryption
salts, as described in the software [build][build] document.

[MAVLink]: http://qgroundcontrol.org/mavlink/start

The GCS can be started by executing on the command line by running the shell
script

```
./gcs.sh
```

located in `smaccmpilot-build/smaccmpilot-stm32f4/`.  This shell script is
generated by the build system in order to embed the keys, salts, and system
identifiers specific to the flight firmware build.  Note that the shell script
will need to be rebuilt if you change the keys or salt.

Executing the script opens two terminal windows:

 1. a window running a (modified)
    [MAVProxy GCS](http://qgroundcontrol.org/mavlink/mavproxy_startpage).
    MAVProxy is your interface to send/receive messages to the UAV.  (Any
    software system supporting MAVLink can be supported.)

 2. a window running a gateway server.  The gateway server prints to standard
    out and standard error, but you will not enter commands here.  The gateway
    is responsible for packing/unpacking MAVLink messages into/out of commsec
    packets.  The gateway has options to see the MAVLink commands being
    sent/received as well as warnings/errors; see the script `gcs.sh` for
    options.

![](/images/gcsdiagram.png)

By default, the gateway server speaks to MAVProxy on TCP port `127.0.0.1:6000`,
and the gateway talks to the serial port `/dev/ttyUSB0` at 57600 baud.  The
radio (or serial-to-USB adaptor) is expected to be on the serial port.

The commsec protocol uses message sequence numbers that must be monotonically
increasing; otherwise, a reply attack is assumed.  Thus, if either SMACCMPilot
or the GCS is reset and sends stale sequence numbers, those messages are
rejected at the other endpoint.  Thus, if one end is restarted, the other end
must be restarted as well.

Unless something goes wrong, you should see very few warnings/errors in the
commsec terminal window (you may get intermittent failures due to lost or
corrupted messages).  However, for example, if you reboot the PX4 while the GCS
is attached to it, the IV counters become stale, and messages are thrown away.

The gateway server can be used to debug messages.  In particular, MAVLink
messages to the vehicle are taged with `toveh` and those from the vehicle are
marked `fromveh`.  For example, starting the gateway server in debugging mode
(`-d`) sends messages passing through to standard error.  To see MAVLink
messages sent to the vehicle only, one can execute

```
./gcs.sh -d 2>&1 | grep toveh
```

[aesgcm-wiki]: http://en.wikipedia.org/wiki/Galois/Counter_Mode
[build]: build.html

